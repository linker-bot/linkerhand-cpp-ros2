name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build_job:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_ver: "20.04"
            ros_distro: "foxy"
            image: "osrf/ros:foxy-desktop"
          - os_ver: "22.04"
            ros_distro: "humble"
            image: "osrf/ros:humble-desktop"

    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for Windows Line Endings (CRLF)
        run: |
          echo "æ­£åœ¨æ£€æŸ¥é¡¹ç›®ä¸­çš„ CRLF æ¢è¡Œç¬¦..."
          # æŸ¥æ‰¾æ‰€æœ‰æºæ–‡ä»¶ï¼Œæ’é™¤ .git ç›®å½•å’ŒäºŒè¿›åˆ¶æ–‡ä»¶
          # å¦‚æœå‘ç°åŒ…å« \r (CRLF) çš„æ–‡ä»¶ï¼Œgrep ä¼šè¿”å› 0
          CRLF_FILES=$(find . -type f -not -path '*/.*' -exec file {} + | grep "CRLF" | cut -d: -f1)
          
          if [ -n "$CRLF_FILES" ]; then
            echo "âŒ é”™è¯¯: å‘ç°ä»¥ä¸‹æ–‡ä»¶åŒ…å« Windows (CRLF) æ¢è¡Œç¬¦:"
            echo "$CRLF_FILES"
            echo "è¯·åœ¨æœ¬åœ°è¿è¡Œ: dos2unix <æ–‡ä»¶å> è¿›è¡Œä¿®å¤ï¼Œæˆ–é…ç½® git autocrlfã€‚"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ–‡ä»¶å‡ä½¿ç”¨ Unix (LF) æ¢è¡Œç¬¦ã€‚"
          fi

      - name: Install System Dependencies
        run: |
          apt-get update && apt-get install -y \
            git build-essential nlohmann-json3-dev
          rosdep update
          rosdep install --from-paths . --ignore-src -y -r

      - name: Setup LinkerHand SDK
        run: |
          git clone https://github.com/linker-bot/linkerhand-cpp-sdk.git /tmp/sdk
          cd /tmp/sdk && mkdir build && cd build
          cmake ..
          make -j$(nproc)
          make install
          ldconfig

      - name: Build Workspace
        id: build_step
        run: |
          . /opt/ros/${{ matrix.ros_distro }}/setup.sh
          colcon build --event-handlers console_direct+

      - name: Run Linter
        id: test_step
        run: |
          . /opt/ros/${{ matrix.ros_distro }}/setup.sh
          colcon test --packages-select linker_hand_cpp_ros2 --event-handlers console_direct+
          colcon test-result --verbose

      - name: Generate Summary
        if: always()
        run: |
          echo "### ğŸš€ CI Summary for Ubuntu ${{ matrix.os_ver }} (${{ matrix.ros_distro }})" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build_step.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests/Linter | ${{ steps.test_step.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
