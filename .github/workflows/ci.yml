name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint_job:
    name: Format & Static Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Check for Windows Line Endings (CRLF)
        id: check_crlf
        run: |
          echo "ðŸ” æ­£åœ¨æ£€æŸ¥é¡¹ç›®ä¸­çš„ CRLF æ¢è¡Œç¬¦..."
          # æŽ’é™¤ .git å’Œ build ç›®å½•
          CRLF_FILES=$(find . -type f -not -path '*/.*' -not -path './build/*' -exec file {} + | grep "CRLF" | cut -d: -f1)
          
          if [ -n "$CRLF_FILES" ]; then
            echo "âŒ é”™è¯¯: å‘çŽ°ä»¥ä¸‹æ–‡ä»¶åŒ…å« Windows (CRLF) æ¢è¡Œç¬¦:"
            echo "$CRLF_FILES"
            echo "è¯·åœ¨æœ¬åœ°è¿è¡Œ: find . -type f -exec dos2unix {} + ä¿®å¤ã€‚"
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ–‡ä»¶å‡ä½¿ç”¨ Unix (LF) æ¢è¡Œç¬¦ã€‚"
          fi

      - name: Generate Lint Summary
        if: always()
        run: |
          echo "### ðŸ“‹ Format Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Check Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| CRLF Line Endings | ${{ steps.check_crlf.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

  build_job:
    name: Build - Ubuntu ${{ matrix.os_ver }} (${{ matrix.ros_distro }})
    needs: lint_job
    strategy:
      fail-fast: false
      matrix:
        include:
          - os_ver: "20.04"
            ros_distro: "foxy"
            image: "osrf/ros:foxy-desktop"
          - os_ver: "22.04"
            ros_distro: "humble"
            image: "osrf/ros:humble-desktop"

    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.image }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          apt-get update && apt-get install -y git build-essential nlohmann-json3-dev
          rosdep update
          rosdep install --from-paths . --ignore-src -y -r --rosdistro ${{ matrix.ros_distro }}

      - name: Setup LinkerHand SDK
        run: |
          git clone https://github.com/linker-bot/linkerhand-cpp-sdk.git /tmp/sdk
          cd /tmp/sdk && mkdir build && cd build
          cmake .. && make -j$(nproc) && make install && ldconfig

      - name: Build Workspace
        id: build_step
        run: |
          . /opt/ros/${{ matrix.ros_distro }}/setup.sh
          colcon build --event-handlers console_direct+

      - name: Run Tests
        id: test_step
        run: |
          . /opt/ros/${{ matrix.ros_distro }}/setup.sh
          # è¿è¡Œæµ‹è¯•ï¼ŒæŽ’é™¤å› ç½‘ç»œå¯¼è‡´æ˜“å¤±è´¥çš„ xmllint (å·²åœ¨ CMakeLists ä¸­å±è”½åˆ™æ— éœ€æ­¤å¤„æŽ’é™¤)
          colcon test --packages-select linker_hand_cpp_ros2 --event-handlers console_direct+
          colcon test-result --verbose

      - name: Generate Build Summary
        if: always()
        run: |
          echo "### ðŸš€ Build Summary for ${{ matrix.ros_distro }}" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| Compilation | ${{ steps.build_step.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ steps.test_step.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
